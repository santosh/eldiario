<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <title>eldiario</title>
  <style>
    #eldiario {
      margin: 0 auto;
    }
  </style>
</head>

<body class="container">
  <h1 class="h1">eldiario</h1>

  <table class="table" id="eldiario"></table>
  <script>
    window.onload = regeneratePage();
    window.setInterval(regeneratePage, 300000); // 300000 = 5 minutes; user can always reload

    function regeneratePage() {
      xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function () {
        if (this.readyState == 4 && xhr.status >= 200) {
          let res = this.responseText;
          let table = document.getElementById("eldiario");
          generateTable(table, res);
        }
      };
      xhr.open("GET", "http://127.0.0.1:8080/entry")
      xhr.send()
    };


    /**
     * Wrapper to generateTableHead and generateTableBody.
     * 
     * @param {Object}                      table - table element to do operations on.
     * @param {XMLHttpRequest.responseText} res - response from ajax call.
    */
    function generateTable(table, res) {
      table.innerHTML = "";
      json = JSON.parse(res);
      let headers = Object.keys(json[0]);
      generateTableBody(table, json);
      generateTableHead(table, headers);
    };

    /**
     * Generates thead on the table. Operates on keys of the JSON.
     * 
     * @param {Object} table - table element to generate thead for.
     * @param {JSON} data - JSON data to insert to table.
    */
    function generateTableHead(table, data) {
      let thead = table.createTHead();
      let row = thead.insertRow();
      for (let key of data) {
        let th = document.createElement("th");
        let text = document.createTextNode(key);
        th.appendChild(text);
        row.appendChild(th);
      }
    };

    /**
     * Generates tbody on the table. Operates on JSON resonse from server.
     * 
     * @param {Object} table - table element to generate tbody for.
     * @param {JSON} data - JSON data to insert to table.
    */
    function generateTableBody(table, data) {
      for (let element of data) {
        let row = table.insertRow();
        for (key in element) {
          let cell = row.insertCell();
          let text = document.createTextNode(element[key]);
          cell.appendChild(text);
        }
      }
    };
  </script>
</body>

</html>
